<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toppers Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #000;
            --header-bg: rgba(20, 5, 10, 0.98);
            --chat-bg: #0f0205;
            --my-msg: #880e4f;
            --other-msg: #1f1f1f;
            --accent: #ff4081;
            --danger: #ff3b30;
            --glass-border: rgba(255, 105, 180, 0.2);
            --admin-gold: #FFD700;
            --verified-blue: #1DA1F2;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #fff;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- UI HELPERS --- */
        .app-view { display: none; flex-direction: column; height: 100%; width: 100%; background: var(--chat-bg); animation: fadeIn 0.3s ease; }
        .hidden { display: none !important; }
        
        /* --- HEADER --- */
        .chat-header { 
            padding: 12px 15px; background: var(--header-bg); 
            border-bottom: 1px solid var(--glass-border); 
            display: flex; align-items: center; justify-content: space-between; 
            flex-shrink: 0; z-index: 10; 
        }
        .header-info { display: flex; flex-direction: column; margin-left: 10px; }
        .chat-title { font-size: 16px; font-weight: 700; }
        .chat-status { font-size: 11px; color: var(--accent); }

        /* --- LANDING --- */
        #landing-view {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; width: 100%; text-align: center; padding: 20px;
        }
        .btn-group { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 320px; margin-top: 30px; }
        .big-btn { 
            border: none; padding: 16px 0; border-radius: 50px; 
            font-size: 15px; font-weight: 600; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 10px; 
            transition: transform 0.2s; color: white; text-decoration: none; position: relative;
        }
        .big-btn:active { transform: scale(0.95); }
        .btn-chat { background: linear-gradient(135deg, #ff4081, #c60055); }
        .btn-admin { background: linear-gradient(135deg, #FFD700, #B8860B); color: #000; }
        .btn-verse { background: linear-gradient(135deg, #9C27B0, #6A1B9A); }
        .btn-inbox { background: linear-gradient(135deg, #2D8CFF, #0055ff); }
        .btn-syllabus { background: #eee; color: #333; }

        /* RED DOT FOR UNREAD MSG */
        .notif-dot {
            position: absolute; top: 15px; right: 25px;
            width: 12px; height: 12px; background: #00e676;
            border-radius: 50%; border: 2px solid var(--my-msg);
            display: none;
        }

        /* --- MESSAGES --- */
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; position: relative; scroll-behavior: smooth; }
        
        .message { 
            max-width: 75%; padding: 8px 12px; border-radius: 12px; font-size: 14px; 
            line-height: 1.4; position: relative; color: #ffd1dc; word-wrap: break-word; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: filter 0.2s;
        }
        .message:active { filter: brightness(1.2); }
        .message.others { align-self: flex-start; background: var(--other-msg); border: 1px solid var(--glass-border); border-top-left-radius: 0; }
        .message.me { align-self: flex-end; background: var(--my-msg); border: 1px solid rgba(255,64,129,0.3); border-top-right-radius: 0; }
        .message.admin-msg { border: 1px solid var(--admin-gold); }
        .message.admin-post { 
            width: 90%; max-width: 90%; align-self: center; 
            background: rgba(40, 30, 10, 0.9); border: 1px solid var(--admin-gold); 
            text-align: center; margin-bottom: 15px;
        }

        .sender-name { font-size: 11px; font-weight: 700; margin-bottom: 2px; color: #ff80ab; display: flex; align-items: center; gap: 4px; cursor: pointer; text-decoration: underline; }
        .message.me .sender-name { display: none; }
        .message.admin-post .sender-name { justify-content: center; color: var(--admin-gold); }
        .verified-tick { color: var(--verified-blue); font-size: 12px; }
        .msg-time { font-size: 9px; opacity: 0.6; float: right; margin-left: 8px; margin-top: 4px; }
        .edited-tag { font-size: 10px; color: #aaa; font-style: italic; margin-left: 4px; }
        
        .chat-img { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 5px; object-fit: contain; cursor: zoom-in; }
        .message.admin-post .chat-img { margin: 10px auto; display: block; }

        /* --- ACTIONS (Long Press) --- */
        .msg-actions { 
            position: absolute; background: #222; padding: 5px 10px; border-radius: 25px; 
            display: none; align-items: center; gap: 10px; z-index: 100; border: 1px solid var(--glass-border); 
        }
        /* Smart Positioning */
        .msg-actions.top { top: -45px; }
        .msg-actions.bottom { top: 100%; margin-top: 5px; }
        
        .message.show-actions .msg-actions { display: flex; }
        .message.others .msg-actions { left: 0; }
        .message.me .msg-actions { right: 0; }
        .action-btn { width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: none; color: #fff; cursor: pointer; }
        .btn-del { background: var(--danger); }
        .btn-edit { background: var(--verified-blue); }
        .btn-reply { background: #444; }

        /* --- SCROLL BTN --- */
        #scrollDownBtn { 
            position: absolute; bottom: 80px; right: 20px; width: 45px; height: 45px; 
            border-radius: 50%; background: #2a0a18; border: 1px solid var(--accent); 
            display: none; justify-content: center; align-items: center; z-index: 90; cursor: pointer;
        }
        .scroll-badge { 
            position: absolute; top: -5px; right: -5px; background: #00e676; color: #000; 
            font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 10px; 
        }

        /* --- FOOTER --- */
        .chat-footer { background: var(--header-bg); border-top: 1px solid var(--glass-border); padding: 10px; }
        .preview-area { display: none; padding: 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border); }
        .preview-area img { height: 50px; border-radius: 5px; border: 1px solid var(--accent); }
        .chat-input-area { display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; background: #2d0c15; border: 1px solid var(--glass-border); border-radius: 25px; padding: 12px 18px; color: #fff; font-size: 15px; }
        .send-btn { background: var(--accent); border: none; width: 45px; height: 45px; border-radius: 50%; color: #fff; display: flex; justify-content: center; align-items: center; }
        .edit-mode-indicator { display: none; background: var(--verified-blue); color: white; padding: 5px 12px; font-size: 11px; border-radius: 6px 6px 0 0; width: fit-content; margin-left: 15px; }
        .edit-mode-indicator.show { display: block; }

        /* --- INBOX LIST --- */
        .list-item { 
            display: flex; justify-content: space-between; align-items: center; padding: 15px; 
            background: #1a1a1a; margin-bottom: 5px; border-radius: 8px; cursor: pointer; border-bottom: 1px solid #333;
        }
        .list-item:active { background: #333; }
        
        /* --- CHECKLIST STYLE (Notion White) --- */
        #checklist-content { 
            background: #ffffff !important; 
            color: #000000 !important; 
            height: 100%; overflow-y: auto; padding: 20px; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        #checklist-content h1 { font-size: 24px; font-weight: 700; margin-bottom: 15px; color: #000; }
        #checklist-content h3 { font-size: 18px; font-weight: 600; margin-top: 25px; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #000; }
        #checklist-content p, #checklist-content blockquote { color: #333; }
        .to-do-list { padding: 0; list-style: none; }
        .to-do-list li { 
            padding: 8px 0; display: flex; align-items: flex-start; 
            border-bottom: 1px solid #f5f5f5; color: #000;
        }
        .custom-checkbox { 
            width: 18px; height: 18px; margin-right: 12px; flex-shrink: 0; 
            cursor: pointer; accent-color: #2D8CFF;
        }
        .completed-text { text-decoration: line-through; opacity: 0.5; color: #888; }

        /* --- MODALS --- */
        .overlay-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; display: none; }
        .action-modal { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: #1e1e1e; 
            border-radius: 20px 20px 0 0; padding: 20px; z-index: 4001; 
            transform: translateY(100%); transition: transform 0.3s ease; 
        }
        .action-modal.open { transform: translateY(0); }
        .modal-option { padding: 15px; background: #333; margin-bottom: 10px; text-align: center; border-radius: 10px; font-weight: 600; cursor: pointer; }

        /* --- CANVAS --- */
        #onlineCanvas { position: fixed; top: 15px; right: 15px; z-index: 3000; pointer-events: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <canvas id="onlineCanvas" width="120" height="40"></canvas>

    <div id="imageViewer" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:7000; justify-content:center; align-items:center;">
        <button onclick="document.getElementById('imageViewer').style.display='none'" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; font-size:30px;">&times;</button>
        <img id="fullImage" style="max-width:100%; max-height:100%;">
    </div>

    <div id="nameModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:6000; display:flex; justify-content:center; align-items:center;">
        <div style="background:#2a0a18; padding:25px; border-radius:16px; width:80%; max-width:300px; text-align:center; border:1px solid var(--accent);">
            <h2 style="color:#fff;">Welcome</h2>
            <input type="text" id="nameInput" style="width:100%; padding:10px; margin:20px 0; border-radius:5px; border:none;" placeholder="Enter Name">
            <button onclick="saveName()" style="width:100%; padding:10px; background:var(--accent); border:none; color:white; border-radius:5px; font-weight:bold;">Start</button>
        </div>
    </div>

    <div id="landing-view">
        <img src="images (8).jpeg" alt="Sir" class="teacher-big-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'" style="width:130px; height:130px; border-radius:50%; border:4px solid var(--danger); object-fit:cover; margin-bottom:20px;">
        <h2 class="scold-headline">"Ab tau match khtm ho gya padhle!" üò°</h2>
        
        <div class="btn-group">
            <button class="big-btn btn-chat" onclick="openView('chat-view')">
                <i class="fas fa-comments"></i> Public Chat
                <span id="homeUnreadBadge" class="notif-dot"></span>
            </button>
            <button class="big-btn btn-inbox" onclick="openInbox()">
                <i class="fas fa-envelope"></i> My Inbox üì©
                <span id="inboxBadge" class="notif-dot"></span>
            </button>
            <button class="big-btn btn-verse" onclick="openView('rangreja-view')"><i class="fas fa-crown"></i> Rangreja Verse</button>
            <button id="adminBtn" class="big-btn btn-admin hidden" onclick="openAdminPanel()"><i class="fas fa-shield-alt"></i> Admin Panel</button>
            <button class="big-btn btn-syllabus" onclick="openView('checklist-view')"><i class="fas fa-tasks"></i> Syllabus Checklist</button>
        </div>
    </div>

    <div id="chat-view" class="app-view">
        <div class="chat-header">
            <button class="back-btn" style="background:none; border:none; color:white; font-size:18px;" onclick="goHome()"><i class="fas fa-arrow-left"></i></button>
            <div class="header-info"><div class="chat-title">Public Chat</div><div class="chat-status" id="onlineCount">‚óè Loading...</div></div>
            <div style="width:30px;"></div>
        </div>
        <div class="chat-messages" id="messagesList"></div>
        <div id="scrollDownBtn" onclick="scrollToBottom()"><i class="fas fa-arrow-down"></i><span id="scrollBadge" class="scroll-badge" style="display:none;">0</span></div>
        <div class="chat-footer">
            <div id="editModeIndicator" class="edit-mode-indicator">Editing <i class="fas fa-times" onclick="cancelEdit()"></i></div>
            <div id="imgPreview" class="preview-area"><img id="thumb"> <i class="fas fa-times" onclick="clearImg()"></i></div>
            <div id="replyPreview" class="preview-area" style="color:#aaa; font-size:12px;">Replying... <i class="fas fa-times" onclick="cancelReply()"></i></div>
            <div class="chat-input-area">
                <input type="file" id="imgInput" hidden accept="image/*" onchange="handleImg('public')">
                <button class="icon-btn" style="background:none; border:none; color:#aaa; font-size:20px;" onclick="document.getElementById('imgInput').click()"><i class="fas fa-paperclip"></i></button>
                <input type="text" class="chat-input" id="msgInput" placeholder="Type a message...">
                <button class="send-btn" onclick="sendMsg('public')"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="dm-view" class="app-view">
        <div class="chat-header" style="background:#1a050b;">
            <button class="back-btn" style="background:none; border:none; color:white; font-size:18px;" onclick="goHome()"><i class="fas fa-arrow-left"></i></button>
            <div class="header-info"><div class="chat-title" id="dmTitle">User</div><div class="chat-status" style="color:#1DA1F2;">Private</div></div>
            <div style="width:30px;"></div>
        </div>
        <div class="chat-messages" id="dmList"></div>
        <div class="chat-footer">
            <div id="dmImgPreview" class="preview-area"><img id="dmThumb"> <i class="fas fa-times" onclick="clearDmImg()"></i></div>
            <div class="chat-input-area">
                <input type="file" id="dmImgInput" hidden accept="image/*" onchange="handleImg('private')">
                <button class="icon-btn" style="background:none; border:none; color:#aaa; font-size:20px;" onclick="document.getElementById('dmImgInput').click()"><i class="fas fa-paperclip"></i></button>
                <input type="text" class="chat-input" id="dmMsgInput" placeholder="Private Message...">
                <button class="send-btn" onclick="sendMsg('private')"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="rangreja-view" class="app-view">
        <div class="chat-header" style="border-bottom: 1px solid var(--admin-gold);">
            <button class="back-btn" style="background:none; border:none; color:white; font-size:18px;" onclick="goHome()"><i class="fas fa-arrow-left"></i></button>
            <div class="header-info"><div class="chat-title" style="color:var(--admin-gold);">Rangreja Verse üëë</div></div>
        </div>
        <div class="chat-messages" id="verseList"></div>
        <div class="chat-footer hidden" id="adminInputArea">
            <div id="verseImgPreview" class="preview-area"><img id="verseThumb"> <i class="fas fa-times" onclick="clearVerseImg()"></i></div>
            <div class="chat-input-area">
                <input type="file" id="verseImgInput" hidden accept="image/*" onchange="handleImg('verse')">
                <button class="icon-btn" style="background:none; border:none; color:#aaa; font-size:20px;" onclick="document.getElementById('verseImgInput').click()"><i class="fas fa-paperclip"></i></button>
                <input type="text" class="chat-input" id="verseInput" placeholder="Admin Update...">
                <button class="send-btn" id="verseSendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="list-view" class="app-view">
        <div class="chat-header">
            <button class="back-btn" style="background:none; border:none; color:white; font-size:18px;" onclick="goHome()"><i class="fas fa-arrow-left"></i></button>
            <div class="header-info"><div class="chat-title" id="listTitle">List</div></div>
        </div>
        <div class="chat-messages" id="genericList"></div>
    </div>

    <div id="checklist-view" class="app-view">
        <div class="chat-header" style="background:#fff; border-bottom:1px solid #ccc;">
            <button class="back-btn" style="background:none; border:none; color:#333; font-size:18px;" onclick="goHome()"><i class="fas fa-arrow-left"></i></button>
            <div class="header-info"><div class="chat-title" style="color:#333;">Syllabus</div></div>
        </div>
        <div id="checklist-content">
            <h1>Class 10 Syllabus</h1>
            <blockquote>Checkboxes are saved automatically.</blockquote>
            
            <h3>Mathematics</h3>
            <ul class="to-do-list">
                <li><input type="checkbox" class="custom-checkbox"> Real Numbers</li>
                <li><input type="checkbox" class="custom-checkbox"> Polynomials</li>
                <li><input type="checkbox" class="custom-checkbox"> Pair of Linear Equations</li>
                <li><input type="checkbox" class="custom-checkbox"> Quadratic Equations</li>
                <li><input type="checkbox" class="custom-checkbox"> Arithmetic Progressions</li>
                <li><input type="checkbox" class="custom-checkbox"> Triangles</li>
                <li><input type="checkbox" class="custom-checkbox"> Coordinate Geometry</li>
                <li><input type="checkbox" class="custom-checkbox"> Introduction to Trigonometry</li>
                <li><input type="checkbox" class="custom-checkbox"> Applications of Trigonometry</li>
                <li><input type="checkbox" class="custom-checkbox"> Circles</li>
                <li><input type="checkbox" class="custom-checkbox"> Areas Related to Circles</li>
                <li><input type="checkbox" class="custom-checkbox"> Surface Areas and Volumes</li>
                <li><input type="checkbox" class="custom-checkbox"> Statistics</li>
                <li><input type="checkbox" class="custom-checkbox"> Probability</li>
            </ul>

            <h3>Science</h3>
            <ul class="to-do-list">
                <li><input type="checkbox" class="custom-checkbox"> Chemical Reactions & Equations</li>
                <li><input type="checkbox" class="custom-checkbox"> Acids, Bases and Salts</li>
                <li><input type="checkbox" class="custom-checkbox"> Metals and Non-metals</li>
                <li><input type="checkbox" class="custom-checkbox"> Carbon and its Compounds</li>
                <li><input type="checkbox" class="custom-checkbox"> Life Processes</li>
                <li><input type="checkbox" class="custom-checkbox"> Control and Coordination</li>
                <li><input type="checkbox" class="custom-checkbox"> How do Organisms Reproduce?</li>
                <li><input type="checkbox" class="custom-checkbox"> Heredity and Evolution</li>
                <li><input type="checkbox" class="custom-checkbox"> Light ‚Äì Reflection and Refraction</li>
                <li><input type="checkbox" class="custom-checkbox"> Human Eye and Colourful World</li>
                <li><input type="checkbox" class="custom-checkbox"> Electricity</li>
                <li><input type="checkbox" class="custom-checkbox"> Magnetic Effects of Electric Current</li>
                <li><input type="checkbox" class="custom-checkbox"> Our Environment</li>
            </ul>

            <h3>Social Science</h3>
            <ul class="to-do-list">
                <li><input type="checkbox" class="custom-checkbox"> Rise of Nationalism in Europe</li>
                <li><input type="checkbox" class="custom-checkbox"> Nationalism in India</li>
                <li><input type="checkbox" class="custom-checkbox"> Making of a Global World</li>
                <li><input type="checkbox" class="custom-checkbox"> Print Culture</li>
                <li><input type="checkbox" class="custom-checkbox"> Resources and Development</li>
                <li><input type="checkbox" class="custom-checkbox"> Forest and Wildlife</li>
                <li><input type="checkbox" class="custom-checkbox"> Water Resources</li>
                <li><input type="checkbox" class="custom-checkbox"> Agriculture</li>
                <li><input type="checkbox" class="custom-checkbox"> Minerals and Energy</li>
                <li><input type="checkbox" class="custom-checkbox"> Manufacturing Industries</li>
                <li><input type="checkbox" class="custom-checkbox"> Lifelines of Economy</li>
                <li><input type="checkbox" class="custom-checkbox"> Power Sharing</li>
                <li><input type="checkbox" class="custom-checkbox"> Federalism</li>
                <li><input type="checkbox" class="custom-checkbox"> Gender, Religion and Caste</li>
                <li><input type="checkbox" class="custom-checkbox"> Political Parties</li>
                <li><input type="checkbox" class="custom-checkbox"> Outcomes of Democracy</li>
                <li><input type="checkbox" class="custom-checkbox"> Development</li>
                <li><input type="checkbox" class="custom-checkbox"> Sectors of Indian Economy</li>
                <li><input type="checkbox" class="custom-checkbox"> Money and Credit</li>
                <li><input type="checkbox" class="custom-checkbox"> Globalisation</li>
            </ul>

            <h3>English</h3>
            <ul class="to-do-list">
                <li><input type="checkbox" class="custom-checkbox"> A Letter to God</li>
                <li><input type="checkbox" class="custom-checkbox"> Nelson Mandela</li>
                <li><input type="checkbox" class="custom-checkbox"> Two Stories about Flying</li>
                <li><input type="checkbox" class="custom-checkbox"> From the Diary of Anne Frank</li>
                <li><input type="checkbox" class="custom-checkbox"> Glimpses of India</li>
                <li><input type="checkbox" class="custom-checkbox"> Mijbil the Otter</li>
                <li><input type="checkbox" class="custom-checkbox"> Madam Rides the Bus</li>
                <li><input type="checkbox" class="custom-checkbox"> Sermon at Benares</li>
                <li><input type="checkbox" class="custom-checkbox"> The Proposal</li>
                <li><input type="checkbox" class="custom-checkbox"> Dust of Snow</li>
                <li><input type="checkbox" class="custom-checkbox"> Fire and Ice</li>
                <li><input type="checkbox" class="custom-checkbox"> A Tiger in the Zoo</li>
                <li><input type="checkbox" class="custom-checkbox"> How to Tell Wild Animals</li>
                <li><input type="checkbox" class="custom-checkbox"> The Ball Poem</li>
                <li><input type="checkbox" class="custom-checkbox"> Amanda</li>
                <li><input type="checkbox" class="custom-checkbox"> The Trees</li>
                <li><input type="checkbox" class="custom-checkbox"> Fog</li>
                <li><input type="checkbox" class="custom-checkbox"> Custard the Dragon</li>
                <li><input type="checkbox" class="custom-checkbox"> For Anne Gregory</li>
                <li><input type="checkbox" class="custom-checkbox"> A Triumph of Surgery</li>
                <li><input type="checkbox" class="custom-checkbox"> The Thief's Story</li>
                <li><input type="checkbox" class="custom-checkbox"> The Midnight Visitor</li>
                <li><input type="checkbox" class="custom-checkbox"> A Question of Trust</li>
                <li><input type="checkbox" class="custom-checkbox"> Footprints without Feet</li>
                <li><input type="checkbox" class="custom-checkbox"> The Making of a Scientist</li>
                <li><input type="checkbox" class="custom-checkbox"> The Necklace</li>
                <li><input type="checkbox" class="custom-checkbox"> Bholi</li>
                <li><input type="checkbox" class="custom-checkbox"> Book That Saved the Earth</li>
            </ul>
            
            <h3>Grammar & Exam Prep</h3>
            <ul class="to-do-list">
                <li><input type="checkbox" class="custom-checkbox"> Tenses, Modals, Subject-Verb Agreement</li>
                <li><input type="checkbox" class="custom-checkbox"> Reported Speech, Determiners</li>
                <li><input type="checkbox" class="custom-checkbox"> Reading Comprehension</li>
                <li><input type="checkbox" class="custom-checkbox"> Writing (Letter, Analytical Para)</li>
                <li><input type="checkbox" class="custom-checkbox"> Solve Sample Papers</li>
                <li><input type="checkbox" class="custom-checkbox"> Mock Tests</li>
            </ul>
        </div>
    </div>

    <div class="overlay-bg" id="actionOverlay" onclick="closeModal()"></div>
    <div class="action-modal" id="userModal">
        <h3 id="modalUser" style="color:var(--accent); text-align:center; margin-bottom:20px;">User</h3>
        <div id="dmOption" class="modal-option" style="color:var(--verified-blue);" onclick="startDM()">
            <i class="fas fa-comment"></i> Message Privately
        </div>
        <div class="modal-option" style="color:#aaa;" onclick="closeModal()">Cancel</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, setDoc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, push, onDisconnect, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyA9HL7EEx35kDraxZAH8mT_YhZGiruy_rY",
          authDomain: "toppers-chat.firebaseapp.com",
          projectId: "toppers-chat",
          storageBucket: "toppers-chat.firebasestorage.app",
          messagingSenderId: "855764275912",
          appId: "1:855764275912:web:c3098e8239c93fb1f54bfd",
          databaseURL: "https://toppers-chat-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        
        let currentUser = localStorage.getItem("chatUserName");
        let selectedUser = null;
        let dmSubscription = null;
        let selectedImg = null;
        let editingId = null;
        let isAtBottom = true;
        let isChatActive = false;

        if(!currentUser) {
            document.getElementById('nameModal').style.display = 'flex';
        } else {
            document.getElementById('nameModal').style.display = 'none';
            initApp();
        }

        window.saveName = () => {
            const name = document.getElementById('nameInput').value.trim();
            if(!name) return;
            if(name.toLowerCase() === "rangreja" && prompt("Admin Pass:") !== "admin123") return;
            localStorage.setItem("chatUserName", name);
            currentUser = name;
            document.getElementById('nameModal').style.display = 'none';
            initApp();
        };

        function initApp() {
            registerUser();
            setupPresence();
            if(currentUser.toLowerCase() === "rangreja") {
                document.getElementById('adminBtn').classList.remove('hidden');
                document.getElementById('adminInputArea').classList.remove('hidden');
                monitorInbox();
            } else {
                monitorInbox(); // Also monitor for normal users to see Red Dot
            }
        }

        async function registerUser() {
            await setDoc(doc(db, "users", currentUser), { name: currentUser, lastActive: serverTimestamp() }, { merge: true });
        }

        function setupPresence() {
            const conRef = ref(rtdb, ".info/connected");
            const onlineRef = ref(rtdb, "online_users");
            onValue(conRef, (snap) => {
                if(snap.val()) {
                    const me = push(onlineRef);
                    onDisconnect(me).remove();
                    set(me, { user: currentUser });
                }
            });
            onValue(onlineRef, snap => {
                const count = snap.size || 0;
                document.getElementById('onlineCount').innerText = `‚óè ${count} Online`;
                const cvs = document.getElementById('onlineCanvas');
                const ctx = cvs.getContext('2d');
                ctx.clearRect(0,0,120,40);
                ctx.fillStyle = document.getElementById('checklist-view').style.display === 'flex' ? 'black' : 'white';
                ctx.font = 'bold 14px Inter';
                ctx.fillText(`‚óè ${count} Online`, 20, 25);
            });
        }

        // --- NAVIGATION ---
        window.openView = (id) => {
            document.querySelectorAll('.app-view').forEach(v => v.style.display = 'none');
            document.getElementById('landing-view').style.display = 'none';
            document.getElementById(id).style.display = 'flex';
            
            isChatActive = (id === 'chat-view');
            if(isChatActive) { 
                document.getElementById('homeUnreadBadge').style.display = 'none'; 
                loadPublicChat();
            }
            if(id === 'rangreja-view') loadVerse();
        };

        window.goHome = () => {
            document.querySelectorAll('.app-view').forEach(v => v.style.display = 'none');
            document.getElementById('landing-view').style.display = 'flex';
            isChatActive = false;
            if(dmSubscription) dmSubscription();
        };

        // --- PUBLIC CHAT ---
        function loadPublicChat() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(150));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById("messagesList");
                list.innerHTML = "";
                const msgs = [];
                let hasNew = false;
                snapshot.docChanges().forEach(c => { if(c.type === 'added') hasNew = true; });

                snapshot.forEach(d => msgs.push({id:d.id, ...d.data()}));
                msgs.reverse().forEach(msg => renderMessage(msg, list, false));
                
                if(hasNew) {
                    if(isChatActive && isAtBottom) {
                        list.scrollTop = list.scrollHeight;
                    } else if(!isChatActive) {
                        document.getElementById('homeUnreadBadge').style.display = 'block';
                    } else {
                        const badge = document.getElementById('scrollBadge');
                        badge.innerText = parseInt(badge.innerText) + 1;
                        badge.style.display = 'block';
                    }
                }
            });
            
            const list = document.getElementById("messagesList");
            list.onscroll = () => {
                isAtBottom = (list.scrollHeight - list.scrollTop - list.clientHeight) < 150;
                document.getElementById('scrollDownBtn').style.display = isAtBottom ? 'none' : 'flex';
                if(isAtBottom) {
                    document.getElementById('scrollBadge').innerText = '0';
                    document.getElementById('scrollBadge').style.display = 'none';
                }
            };
        }

        window.scrollToBottom = () => {
            const list = document.getElementById("messagesList");
            list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
        };

        // --- DM SYSTEM RESTRICTION ---
        window.openUserModal = (name) => {
            if(name === currentUser) return;
            selectedUser = name;
            
            const iamAdmin = currentUser.toLowerCase() === "rangreja";
            const targetIsAdmin = name.toLowerCase() === "rangreja";
            
            // Only Admin can DM anyone, Others can ONLY DM Admin
            if(iamAdmin || targetIsAdmin) {
                document.getElementById('dmOption').style.display = 'block';
            } else {
                document.getElementById('dmOption').style.display = 'none';
            }

            document.getElementById('modalUser').innerText = name;
            document.getElementById('actionOverlay').style.display = 'block';
            document.getElementById('userModal').classList.add('open');
        };

        window.closeModal = () => {
            document.getElementById('actionOverlay').style.display = 'none';
            document.getElementById('userModal').classList.remove('open');
        };

        window.startDM = () => {
            closeModal();
            document.querySelectorAll('.app-view').forEach(v => v.style.display = 'none');
            document.getElementById('landing-view').style.display = 'none';
            document.getElementById('dm-view').style.display = 'flex';
            document.getElementById('dmTitle').innerText = selectedUser;
            
            const chatId = [currentUser, selectedUser].sort().join("_");
            setDoc(doc(db, "users", currentUser, "inbox", selectedUser), { name: selectedUser, lastMsg: serverTimestamp() });
            setDoc(doc(db, "users", selectedUser, "inbox", currentUser), { name: currentUser, lastMsg: serverTimestamp() });

            const q = query(collection(db, "private_chats", chatId, "messages"), orderBy("createdAt", "asc"));
            if(dmSubscription) dmSubscription();
            dmSubscription = onSnapshot(q, (snap) => {
                const list = document.getElementById("dmList");
                list.innerHTML = "";
                snap.forEach(d => renderMessage({id:d.id, ...d.data()}, list, true));
                list.scrollTop = list.scrollHeight;
            });
        };

        function monitorInbox() {
            onSnapshot(collection(db, "users", currentUser, "inbox"), (snap) => {
                let hasChanges = false;
                snap.docChanges().forEach(c => { if(c.type === 'added' || c.type === 'modified') hasChanges = true; });
                if(hasChanges) document.getElementById('inboxBadge').style.display = 'block';
            });
        }

        window.openInbox = () => {
            document.getElementById('inboxBadge').style.display = 'none';
            openView('list-view');
            document.getElementById('listTitle').innerText = "My Inbox";
            const list = document.getElementById("genericList");
            onSnapshot(collection(db, "users", currentUser, "inbox"), (snap) => {
                list.innerHTML = "";
                snap.forEach(d => {
                    const div = document.createElement("div");
                    div.className = "list-item";
                    div.innerHTML = `<b>${d.data().name}</b>`;
                    
                    // Long press to delete Logic
                    let pressTimer;
                    div.addEventListener('touchstart', () => pressTimer = setTimeout(() => {
                        if(confirm("Delete this chat from inbox?")) deleteDoc(doc(db,'users',currentUser,'inbox',d.id));
                    }, 800));
                    div.addEventListener('touchend', () => clearTimeout(pressTimer));
                    
                    div.onclick = () => { selectedUser = d.data().name; startDM(); };
                    list.appendChild(div);
                });
            });
        };

        // --- ADMIN PANEL ---
        window.openAdminPanel = () => {
            openView('list-view');
            document.getElementById('listTitle').innerText = "Admin Panel";
            const list = document.getElementById("genericList");
            onSnapshot(collection(db, "users"), (snap) => {
                list.innerHTML = "";
                snap.forEach(d => {
                    const u = d.data();
                    if(u.name.toLowerCase() === "rangreja") return;
                    const div = document.createElement("div");
                    div.className = "list-item";
                    div.innerHTML = `<span>${u.name} ${u.isBlocked?'(üî¥)':''}</span> 
                    <div>
                        <button onclick="event.stopPropagation(); toggleBlock('${d.id}', ${u.isBlocked})" style="color:red; background:none; border:1px solid red; margin-right:5px;">${u.isBlocked?'Unblock':'Block'}</button>
                        <button onclick="event.stopPropagation(); selectedUser='${u.name}'; startDM();" style="color:cyan; background:none; border:1px solid cyan;">DM</button>
                    </div>`;
                    list.appendChild(div);
                });
            });
        };

        window.toggleBlock = async (uid, status) => { if(confirm("Change Status?")) await updateDoc(doc(db, "users", uid), { isBlocked: !status }); };

        // --- RANGREJA VERSE ---
        function loadVerse() {
            const q = query(collection(db, "rangreja_updates"), orderBy("createdAt", "desc"));
            onSnapshot(q, snap => {
                const list = document.getElementById("verseList");
                list.innerHTML = "";
                snap.forEach(d => {
                    const msg = d.data();
                    const div = document.createElement("div");
                    div.className = "message admin-post";
                    
                    // Delete Button for Admin Only
                    let delBtn = "";
                    if(currentUser.toLowerCase() === "rangreja") {
                        delBtn = `<i class="fas fa-trash" style="float:right; color:red; cursor:pointer;" onclick="deleteDoc(doc(db,'rangreja_updates','${d.id}'))"></i>`;
                    }

                    const imgHtml = msg.image ? `<img src="${msg.image}" class="chat-img" onclick="document.getElementById('imageViewer').style.display='flex'; document.getElementById('fullImage').src=this.src;">` : "";
                    
                    div.innerHTML = `${delBtn} <span class="sender-name">Rangreja <i class="fas fa-check-circle verified-tick"></i></span> ${imgHtml} <div>${msg.text}</div>`;
                    list.appendChild(div);
                });
            });
        }

        window.sendVerse = async () => {
            const txt = document.getElementById("verseInput").value;
            if(!txt && !selectedImg) return;
            const data = { text: txt, createdAt: serverTimestamp() };
            if(selectedImg) data.image = selectedImg;
            await addDoc(collection(db, "rangreja_updates"), data);
            document.getElementById("verseInput").value = "";
            clearVerseImg();
        };

        // --- SHARED MESSAGE LOGIC ---
        function renderMessage(msg, list, isPrivate) {
            const div = document.createElement("div");
            const isMe = msg.user === currentUser;
            const isAdminMsg = msg.user.toLowerCase() === "rangreja";
            const amIAdmin = currentUser.toLowerCase() === "rangreja";
            
            div.className = `message ${isMe ? 'me' : 'others'} ${isAdminMsg ? 'admin-msg' : ''}`;
            
            let imgHtml = msg.image ? `<img src="${msg.image}" class="chat-img" onclick="event.stopPropagation(); document.getElementById('imageViewer').style.display='flex'; document.getElementById('fullImage').src=this.src;">` : "";
            let nameTag = isMe ? "" : `<span class="sender-name" onclick="openUserModal('${msg.user}')">${msg.user} ${isAdminMsg ? '<i class="fas fa-check-circle verified-tick"></i>' : ''}</span>`;
            
            // ACTION BUTTONS
            let actions = `<div class="msg-actions">
                ${isMe ? `<button class="action-btn btn-edit" onclick="editMsg('${msg.id}', '${msg.text}', ${isPrivate})"><i class="fas fa-pen"></i></button>` : ''}
                ${(isMe || amIAdmin) ? `<button class="action-btn btn-del" onclick="delMsg('${msg.id}', ${isPrivate})"><i class="fas fa-trash"></i></button>` : ''}
                <button class="action-btn btn-reply" onclick="replyMsg('${msg.user}')"><i class="fas fa-reply"></i></button>
            </div>`;

            // Smart Menu Positioning
            let timer;
            const startPress = () => timer = setTimeout(() => { 
                document.querySelectorAll('.message').forEach(m=>m.classList.remove('show-actions'));
                div.classList.add('show-actions');
                const menu = div.querySelector('.msg-actions');
                // Check if message is at top of screen to flip menu down
                if(div.getBoundingClientRect().top < 100) { menu.classList.remove('top'); menu.classList.add('bottom'); }
                else { menu.classList.remove('bottom'); menu.classList.add('top'); }
                navigator.vibrate(50); 
            }, 500);
            
            const endPress = () => clearTimeout(timer);
            div.addEventListener('touchstart', startPress, {passive: true});
            div.addEventListener('touchend', endPress);
            div.addEventListener('contextmenu', e => { e.preventDefault(); });

            div.innerHTML = `${actions} ${nameTag} ${imgHtml} <div>${msg.text} ${msg.isEdited?'<span class="edited-tag">(edited)</span>':''}</div> <div class="msg-time">${new Date(msg.createdAt?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
            list.appendChild(div);
        }

        window.sendMsg = async (type) => {
            const u = await getDoc(doc(db, "users", currentUser));
            // Block logic: Allow DM to Rangreja even if blocked
            const isToRangreja = selectedUser && selectedUser.toLowerCase() === "rangreja";
            const amIAdmin = currentUser.toLowerCase() === "rangreja";

            if(u.exists() && u.data().isBlocked && !isToRangreja) return alert("You are Blocked.");

            // STRICT DM CHECK: If not public, sender MUST be Admin or Receiver MUST be Admin
            if(type === 'private') {
                const targetIsAdmin = selectedUser.toLowerCase() === "rangreja";
                if (!amIAdmin && !targetIsAdmin) {
                    return alert("You can only DM the Admin.");
                }
            }

            const txtId = type==='public'?'msgInput':'dmMsgInput';
            const imgId = type==='public'?'imgInput':'dmImgInput';
            const txt = document.getElementById(txtId).value.trim();
            const file = document.getElementById(imgId).files[0];

            if(!txt && !file && !selectedImg) return;

            let imgData = selectedImg;
            const data = { text: txt, user: currentUser, createdAt: serverTimestamp() };
            if(imgData) data.image = imgData;

            if(type === 'public') await addDoc(collection(db, "messages"), data);
            else {
                const id = [currentUser, selectedUser].sort().join("_");
                await addDoc(collection(db, "private_chats", id, "messages"), data);
            }
            
            document.getElementById(txtId).value = "";
            clearImg(); clearDmImg();
        };

        window.delMsg = async (id, isPrivate) => {
            if(!confirm("Delete?")) return;
            if(isPrivate) {
                const chatId = [currentUser, selectedUser].sort().join("_");
                await deleteDoc(doc(db, "private_chats", chatId, "messages", id));
            } else {
                await deleteDoc(doc(db, "messages", id));
            }
        };

        window.editMsg = (id, txt, isPriv) => {
            editingId = id; 
            const input = document.getElementById(isPriv ? 'dmMsgInput' : 'msgInput');
            input.value = txt; input.focus();
            document.querySelector(isPriv ? '#dmSendBtn' : '#sendBtn').style.color = '#00e676';
        };

        window.handleImg = (type) => {
            const input = document.getElementById(type==='public'?'imgInput':(type==='private'?'dmImgInput':'verseImgInput'));
            const file = input.files[0];
            if(file) {
                const r = new FileReader();
                r.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        let w=img.width, h=img.height;
                        if(w>800){ h*=800/w; w=800; }
                        cvs.width=w; cvs.height=h;
                        cvs.getContext('2d').drawImage(img,0,0,w,h);
                        selectedImg = cvs.toDataURL('image/jpeg',0.6);
                        
                        if(type==='public') { document.getElementById('thumb').src=selectedImg; document.getElementById('imgPreview').style.display='block'; }
                        else if(type==='private') { document.getElementById('dmThumb').src=selectedImg; document.getElementById('dmImgPreview').style.display='block'; }
                        else { document.getElementById('verseThumb').src=selectedImg; document.getElementById('verseImgPreview').style.display='block'; }
                    }
                    img.src = e.target.result;
                };
                r.readAsDataURL(file);
            }
        };

        window.clearImg = () => { selectedImg=null; document.getElementById('imgInput').value=''; document.getElementById('imgPreview').style.display='none'; };
        window.clearDmImg = () => { selectedImg=null; document.getElementById('dmImgInput').value=''; document.getElementById('dmImgPreview').style.display='none'; };
        window.clearVerseImg = () => { selectedImg=null; document.getElementById('verseImgInput').value=''; document.getElementById('verseImgPreview').style.display='none'; };
        window.replyMsg = (u) => { document.getElementById('msgInput').value = `@${u} `; };
        
        document.getElementById("verseSendBtn").addEventListener("click", sendVerse);
        document.getElementById("adminSendBtn")?.addEventListener("click", sendVerse);

        // Checklist
        document.querySelectorAll('.custom-checkbox').forEach((cb, i) => {
            const label = cb.nextElementSibling;
            cb.checked = localStorage.getItem('cb_'+i) === 'true';
            if(cb.checked) label.classList.add('completed-text');
            cb.onclick = () => {
                localStorage.setItem('cb_'+i, cb.checked);
                label.classList.toggle('completed-text', cb.checked);
            };
        });
    </script>
</body>
</html>
